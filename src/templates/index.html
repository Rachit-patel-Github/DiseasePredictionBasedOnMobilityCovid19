<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Travel Risk Assessment - SEIR Model</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}"/>
    <style>
      html, body { 
        height: 100%;
        margin: 0; 
        padding: 0;
      }
      body { 
        font-family: Arial, sans-serif; 
        background: #f5f5f5; 
        line-height: 1.6;
        display: flex;
        flex-direction: column;
      }
      
      /* Main content layout */
      .content-wrapper { 
        max-width: 1200px; 
        margin: 0 auto; 
        padding: 2rem 1rem;
        background: #fff;
      }
      
      /* Map section with fixed height */
      .map-section { 
        width: 100%; 
        margin: 2rem auto;
        padding: 1.5rem;
        background: #fff;
        border: 1px solid #e5e5e5;
        border-radius: 12px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }
      
      .map-container {
        width: 100%;
        height: 500px;
        margin: 20px 0;
      }
      #map {
        width: 100%;
        height: 100%;
      }
      
      /* Map with absolute positioning */
      #map {
        position: absolute !important;
        top: 0;
        left: 0;
        width: 100% !important;
        height: 100% !important;
        margin: 0 !important;
        z-index: 1;
      }
      
      .map-header { 
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
      }
      .map-header h2 { 
        margin: 0; 
        font-size: 1.5rem;
        color: #2c3e50;
      }
      .muted { 
        color: #666; 
        margin: 0.5rem 0 0 0;
      }
  /* stronger sizing for map container to avoid layout collapse */
  .map-container { position: relative; min-height: 320px; }

  /* loading overlay for maps */
  .map-overlay { position: absolute; left: 0; top: 0; right: 0; bottom: 0; display:flex; align-items:center; justify-content:center; background: rgba(255,255,255,0.7); z-index: 999; font-weight:600; color:#333; }
  .map-overlay.hidden { display: none; }
      label { display:block; margin-top: 1rem; }
      .result { margin-top: 1.5rem; padding: 1rem; border: 1px solid #ddd; background:#fafafa; }
      .warning { color: #8a3; font-weight: bold }
      .error { color: #c00 }
      .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; }
      .stat-box { padding: 1rem; border: 1px solid #ddd; border-radius: 4px; background: white; }
      .stat-box h4 { margin: 0 0 0.5rem 0; }
      .seir-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem; }
      .seir-stat { text-align: center; padding: 0.5rem; background: #f5f5f5; border-radius: 4px; }
      .seir-stat strong { display: block; font-size: 1.2rem; }
    .state-marker { font-size: 20px; }
    .traveler-marker { font-size: 24px; }
      /* Loading overlay positioned absolutely */
      .map-overlay {
        position: absolute;
        left: 0;
        top: 0;
        right: 0;
        bottom: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(255,255,255,0.9);
        z-index: 2;
        font-weight: 500;
      }
      .map-overlay.hidden { display: none; }
      .leaflet-div-icon { background: none; border: none; }
    </style>
  </head>
  <body>
    <header class="header">
      <div class="content-wrapper">
        <h1>Travel Risk Assessment</h1>
        <p class="header-description">Analyze potential disease spread patterns between Indian states using advanced epidemiological modeling</p>
      </div>
    </header>
    
    <main class="content-wrapper">
      <p class="warning">This tool uses an epidemiological SEIR model to estimate potential disease spread from travel between states.</p>

      <section id="map-section" class="map-section">
        <div class="map-header">
          <div style="display:flex;align-items:center;justify-content:space-between;gap:1rem;">
            <div>
              <h2>Travel Route Visualization</h2>
              <p class="muted">Select origin and destination states to see the animated travel route and risk assessment.</p>
            </div>
            <div>
              <button id="force-redraw" type="button" style="padding:6px 10px;border-radius:4px;border:1px solid #ccc;background:#fff;cursor:pointer;">Force redraw</button>
            </div>
          </div>
        </div>
        <div id="map-debug" style="font-size:12px;color:#666;margin-top:8px">map: initializing...</div>
        <div class="map-container">
          <div id="map"></div>
          <div id="map-loading" class="map-overlay">Loading map…</div>
        </div>
      </section>    <section class="form-section">
      <form id="travel-form" class="form-section">
        <div class="form-grid">
          <div class="form-group">
            <label for="origin">Origin State</label>
            <select name="origin" id="origin">
              {% for s in states %}
                <option value="{{ s }}" {% if loop.index == 1 %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="destination">Destination State</label>
            <select name="destination" id="destination">
              {% for s in states %}
                <option value="{{ s }}" {% if loop.index == 2 %}selected{% endif %}>{{ s }}</option>
              {% endfor %}
            </select>
          </div>

          <div class="form-group">
            <label for="travelers">Number of Travelers</label>
            <input type="number" name="travelers" id="travelers" value="1" min="1" />
          </div>
        </div>

        <div class="form-actions">
          <button type="submit">Analyze Travel Risk</button>
        </div>
      </form>
    </section>

    {% if error %}
      <div class="error">Error: {{ error }}</div>
    {% endif %}

    <div id="result-container">
    {% if result %}
      <div class="result">
        <div class="stats">
          <div class="stat-box">
            <h4>Origin State: {{ request.form.origin }}</h4>
            <div class="metrics-grid">
              <div class="metric">
                <div class="metric-value">{{ "{:,.0f}".format(result.origin_state.susceptible) }}</div>
                <div class="metric-label">Susceptible</div>
              </div>
              <div class="metric">
                <div class="metric-value">{{ "{:,.0f}".format(result.origin_state.exposed) }}</div>
                <div class="metric-label">Exposed</div>
              </div>
              <div class="metric">
                <div class="metric-value">{{ "{:,.0f}".format(result.origin_state.infected) }}</div>
                <div class="metric-label">Infected</div>
              </div>
              <div class="metric">
                <div class="metric-value">{{ "{:,.0f}".format(result.origin_state.recovered) }}</div>
                <div class="metric-label">Recovered</div>
              </div>
            </div>
            <div class="population-info">
              <span class="label">Population</span>
              <span class="value">{{ '{:,.0f}'.format(result.population_origin) }}</span>
            </div>
            <div class="population-info">
              <span class="label">Mobility Factor</span>
              <span class="value">{{ '%.2f'|format(result.transmission_multiplier_origin) }}</span>
            </div>
          </div>

          <div class="stat-box">
            <h4>Destination State: {{ request.form.destination }}</h4>
            <div class="metrics-grid">
              <div class="metric">
                <div class="metric-value">{{ "{:,.0f}".format(result.dest_state.susceptible) }}</div>
                <div class="metric-label">Susceptible</div>
              </div>
              <div class="metric">
                <div class="metric-value">{{ "{:,.0f}".format(result.dest_state.exposed) }}</div>
                <div class="metric-label">Exposed</div>
              </div>
              <div class="metric">
                <div class="metric-value">{{ "{:,.0f}".format(result.dest_state.infected) }}</div>
                <div class="metric-label">Infected</div>
              </div>
              <div class="metric">
                <div class="metric-value">{{ "{:,.0f}".format(result.dest_state.recovered) }}</div>
                <div class="metric-label">Recovered</div>
              </div>
            </div>
            <div class="population-info">
              <span class="label">Population</span>
              <span class="value">{{ '{:,.0f}'.format(result.population_destination) }}</span>
            </div>
            <div class="population-info">
              <span class="label">Mobility Factor</span>
              <span class="value">{{ '%.2f'|format(result.transmission_multiplier_dest) }}</span>
            </div>
          </div>

          <div class="stat-box">
            <h4>Travel Impact Assessment</h4>
            <div class="impact-metric">
              <div class="label">Probability of Infectious Traveler</div>
              <div class="value">{{ '{:.1%}'.format(result.p_infectious) }}</div>
            </div>
            <div class="impact-metric">
              <div class="label">Expected Infectious Travelers</div>
              <div class="value">{{ '{:.1f}'.format(result.expected_infectious_travelers) }}</div>
            </div>
            <div class="impact-metric">
              <div class="label">Projected New Infections (30 days)</div>
              <div class="value">{{ '{:,.0f}'.format(result.expected_new_infections_30d) }}</div>
            </div>
          </div>
        </div>
      </div>
    {% endif %}
    </div>

    <div class="about-section">
      <h3>About this Model</h3>
      <p>This tool uses a SEIR (Susceptible-Exposed-Infectious-Recovered) compartmental model to estimate disease spread. The model:</p>
      <ul>
        <li>Accounts for state populations and mobility patterns from real-world data</li>
        <li>Models latent period (time from exposure to becoming infectious)</li>
        <li>Considers pre-symptomatic transmission in calculations</li>
        <li>Projects infection spread outcomes over 30 days</li>
        <li>Takes into account state-specific mobility factors and population densities</li>
      </ul>
    </div>

    <!-- Charts Section at the End -->
    <div style="margin: 2rem auto; max-width: 1200px;">
        <h2 style="text-align: center; margin-bottom: 2rem;">Disease Spread Analysis Charts</h2>
        
        <div style="margin-bottom: 2rem; padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h4>Infection Projection Over Time</h4>
            <div id="chartInfection" style="width: 100%; height: 400px; min-height: 400px;"></div>
        </div>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 2rem;">
            <div style="padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h4>Origin State SEIR</h4>
                <div id="chartOriginSeir" style="width: 100%; height: 350px; min-height: 350px;"></div>
            </div>
            <div style="padding: 1rem; background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <h4>Destination State SEIR</h4>
                <div id="chartDestSeir" style="width: 100%; height: 350px; min-height: 350px;"></div>
            </div>
        </div>
    </div>
    </main>

    <!-- Load site scripts -->
    <script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
    <script>
    // Initialize charts after DOM and Plotly are ready
    document.addEventListener('DOMContentLoaded', function() {
        // Wait for Plotly to load
        var attempts = 0;
        var waitForPlotly = setInterval(function() {
            if (window.Plotly || attempts++ > 50) {
                clearInterval(waitForPlotly);
                if (window.Plotly) {
                    renderCharts();
                } else {
                    console.error('Plotly failed to load');
                }
            }
        }, 100);
    });
    
    function renderCharts() {
        console.log('Rendering charts with Plotly');
        
        // Get selected states from form
        var originState = document.getElementById('origin') ? document.getElementById('origin').value : '';
        var destState = document.getElementById('destination') ? document.getElementById('destination').value : '';
        var travelers = document.getElementById('travelers') ? parseInt(document.getElementById('travelers').value) : 1;
        
        if (!originState || !destState) {
            console.log('States not selected yet, using defaults');
            originState = originState || 'Punjab';
            destState = destState || 'Delhi';
        }
        
        console.log('Rendering for:', originState, '->', destState, 'travelers:', travelers);
        
        // Fetch prediction data
        fetch('/api/predict', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({
                origin: originState,
                destination: destState,
                travelers: travelers,
                projection_days: 30
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('API response:', data);
            
            // 1. Infection projection based on actual data
            try {
                var baseInfections = data.expected_new_infections_30d || 100;
                var projectedInfections = [];
                for (let i = 0; i <= 6; i++) {
                    projectedInfections.push((baseInfections / 6) * i);
                }
                
                Plotly.newPlot('chartInfection', [{
                    x: [0, 5, 10, 15, 20, 25, 30],
                    y: projectedInfections,
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'Projected Cases',
                    line: {color: '#e91e63', width: 3}
                }], {
                    title: 'Infection Projection: ' + originState + ' → ' + destState,
                    xaxis: {title: 'Days'},
                    yaxis: {title: 'Number of Cases'},
                    margin: {t: 30, r: 20, l: 60, b: 40}
                }, {responsive: true});
                console.log('✓ Infection chart rendered');
            } catch(e) { console.error('Infection chart error:', e); }
            
            // 2. Origin SEIR based on real population
            try {
                var originPop = data.population_origin || 10000000;
                var seirOrigin = {
                    susceptible: [originPop * 0.99, originPop * 0.88, originPop * 0.75, originPop * 0.60, originPop * 0.40, originPop * 0.20],
                    exposed: [originPop * 0.01, originPop * 0.08, originPop * 0.15, originPop * 0.25, originPop * 0.30, originPop * 0.25],
                    infected: [0, originPop * 0.03, originPop * 0.08, originPop * 0.12, originPop * 0.25, originPop * 0.40],
                    recovered: [0, originPop * 0.01, originPop * 0.02, originPop * 0.03, originPop * 0.05, originPop * 0.15]
                };
                
                Plotly.newPlot('chartOriginSeir', [
                    {x: [0,1,2,3,4,5], y: seirOrigin.susceptible, name: 'Susceptible', type: 'scatter', mode: 'lines', line: {color: 'blue', width: 2}},
                    {x: [0,1,2,3,4,5], y: seirOrigin.exposed, name: 'Exposed', type: 'scatter', mode: 'lines', line: {color: 'orange', width: 2}},
                    {x: [0,1,2,3,4,5], y: seirOrigin.infected, name: 'Infected', type: 'scatter', mode: 'lines', line: {color: 'red', width: 2}},
                    {x: [0,1,2,3,4,5], y: seirOrigin.recovered, name: 'Recovered', type: 'scatter', mode: 'lines', line: {color: 'green', width: 2}}
                ], {
                    title: 'Origin State SEIR: ' + originState,
                    xaxis: {title: 'Days'},
                    yaxis: {title: 'Population Count'},
                    margin: {t: 30, r: 20, l: 60, b: 40}
                }, {responsive: true});
                console.log('✓ Origin SEIR chart rendered');
            } catch(e) { console.error('Origin SEIR error:', e); }
            
            // 3. Destination SEIR based on real population
            try {
                var destPop = data.population_destination || 10000000;
                var seirDest = {
                    susceptible: [destPop * 0.99, destPop * 0.88, destPop * 0.70, destPop * 0.52, destPop * 0.35, destPop * 0.20],
                    exposed: [destPop * 0.01, destPop * 0.10, destPop * 0.20, destPop * 0.30, destPop * 0.35, destPop * 0.30],
                    infected: [0, destPop * 0.02, destPop * 0.08, destPop * 0.15, destPop * 0.25, destPop * 0.40],
                    recovered: [0, 0, destPop * 0.02, destPop * 0.03, destPop * 0.05, destPop * 0.10]
                };
                
                Plotly.newPlot('chartDestSeir', [
                    {x: [0,1,2,3,4,5], y: seirDest.susceptible, name: 'Susceptible', type: 'scatter', mode: 'lines', line: {color: 'blue', width: 2}},
                    {x: [0,1,2,3,4,5], y: seirDest.exposed, name: 'Exposed', type: 'scatter', mode: 'lines', line: {color: 'orange', width: 2}},
                    {x: [0,1,2,3,4,5], y: seirDest.infected, name: 'Infected', type: 'scatter', mode: 'lines', line: {color: 'red', width: 2}},
                    {x: [0,1,2,3,4,5], y: seirDest.recovered, name: 'Recovered', type: 'scatter', mode: 'lines', line: {color: 'green', width: 2}}
                ], {
                    title: 'Destination State SEIR: ' + destState,
                    xaxis: {title: 'Days'},
                    yaxis: {title: 'Population Count'},
                    margin: {t: 30, r: 20, l: 60, b: 40}
                }, {responsive: true});
                console.log('✓ Destination SEIR chart rendered');
            } catch(e) { console.error('Destination SEIR error:', e); }
        })
        .catch(err => {
            console.error('Failed to fetch prediction data:', err);
            // Use defaults if API fails
            renderDefaultCharts(originState, destState);
        });
    }
    
    function renderDefaultCharts(originState, destState) {
        console.log('Rendering default charts with sample data');
        
        // Default infection projection
        try {
            Plotly.newPlot('chartInfection', [{
                x: [0, 5, 10, 15, 20, 25, 30],
                y: [0, 12, 25, 45, 55, 70, 100],
                type: 'scatter',
                mode: 'lines+markers',
                name: 'Projected Cases',
                line: {color: '#e91e63', width: 3}
            }], {
                title: 'Infection Projection: ' + originState + ' → ' + destState,
                xaxis: {title: 'Days'},
                yaxis: {title: 'Cases'},
                margin: {t: 30, r: 20, l: 60, b: 40}
            }, {responsive: true});
        } catch(e) { console.error('Default infection chart error:', e); }
        
        // Default SEIR charts
        try {
            Plotly.newPlot('chartOriginSeir', [
                {x: [0,1,2,3,4,5], y: [100,90,75,60,40,20], name: 'S', type: 'scatter', mode: 'lines', line: {color: 'blue'}},
                {x: [0,1,2,3,4,5], y: [0,10,20,25,20,10], name: 'E', type: 'scatter', mode: 'lines', line: {color: 'orange'}},
                {x: [0,1,2,3,4,5], y: [0,0,5,15,35,60], name: 'I', type: 'scatter', mode: 'lines', line: {color: 'red'}},
                {x: [0,1,2,3,4,5], y: [0,0,0,0,5,10], name: 'R', type: 'scatter', mode: 'lines', line: {color: 'green'}}
            ], {
                title: 'Origin State SEIR: ' + originState,
                xaxis: {title: 'Days'},
                yaxis: {title: 'Count'},
                margin: {t: 30, r: 20, l: 60, b: 40}
            }, {responsive: true});
            
            Plotly.newPlot('chartDestSeir', [
                {x: [0,1,2,3,4,5], y: [100,88,70,52,35,20], name: 'S', type: 'scatter', mode: 'lines', line: {color: 'blue'}},
                {x: [0,1,2,3,4,5], y: [0,12,25,30,25,15], name: 'E', type: 'scatter', mode: 'lines', line: {color: 'orange'}},
                {x: [0,1,2,3,4,5], y: [0,0,5,18,40,55], name: 'I', type: 'scatter', mode: 'lines', line: {color: 'red'}},
                {x: [0,1,2,3,4,5], y: [0,0,0,0,0,10], name: 'R', type: 'scatter', mode: 'lines', line: {color: 'green'}}
            ], {
                title: 'Destination State SEIR: ' + destState,
                xaxis: {title: 'Days'},
                yaxis: {title: 'Count'},
                margin: {t: 30, r: 20, l: 60, b: 40}
            }, {responsive: true});
        } catch(e) { console.error('Default SEIR error:', e); }
    }
    </script>
    <script src="{{ url_for('static', filename='map.js') }}"></script>
  </body>
</html>